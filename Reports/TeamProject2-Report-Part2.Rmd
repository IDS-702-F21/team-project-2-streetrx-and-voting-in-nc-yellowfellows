---
title: \vspace{-1.75cm} **IDS702 Team Yellow Project II**
author: 
  - Anna Dai (Presenter)
  - Athena Liu (Checker)
  - Dauren Bizhanov (Writer)
  - Himangshu Raj Bhantana (Coordinator)
  - Moritz Wilksch (Programmer)
date: October 25, 2021
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)


library(purrr)
library(arm)
library(lattice)
library(ggplot2)
library(dplyr)
library(tidyr)
library(data.table)
library(lme4)
library(GGally)
library(knitr)
library(xtable)
library(kableExtra)
library(stargazer)
```

# Summary

This study investigates how various demographic groups voted in the 2020 general election. We utilized the Hierarchical Logistic Regression model to analyze how the overall likelihood of voting differ by county, party affiliation, and voters demographics such as age, gender, race, and ethnicity. While the model suggested no significant difference in turnout rates between genders, voter turnout rates could differ by race and ethnicity. Among all races, black voters tend to have a lower likelihood to vote compared to Asian voters. Ethnicity-wise, Hispanic voters tend to have a lower likelihood to vote compared to Non-Hispanic voters. Age and gender are examined in combination with party affiliation. Among all political parties, the age group "26-40" has the lowest turnout rate, and the age group "over 66" has the highest turnout rates. In addition, being a male member of the Green party or an undesignated gender member of the Libertarian Party is associated with a higher likelihood of voting than a female member of the Constitutional party. Lastly, the model indicated that there are differences in voting likelihood between counties. Carteret, Alexander, Orange have the highest turnout rates. Meanwhile, Robeson, Cherokee, Anson have the lowest turnout rates. 

# Introduction
The North Carolina State Board of Elections (NCSBE) oversees election administration as well as campaign finance disclosure and compliance. They give voter registration and turnout information online, among other things, via the ncsbe.gov website. Using the NC voter files for the general elections in November 2020, we attempt to identify/estimate the voting behavior of various demographic groups in the 2020 elections in North Carolina. We also employ a hierarchical model to capture the geographical differences of the voting turnout by county. In this study, we take a sample of 25 NC counties to analyze. In addition, we aim to answer the following questions of interest: what was the difference in turnout rates between men and women for each party affiliation as well as what was the difference in turnout rates between age groups for each party affiliation. 

# Data

```{r echo=FALSE}
voters = read.csv("../Data/voter_stats_20201103.txt", sep="\t")
unique_counties = unique(voters$county_desc)
set.seed(42); used_counties = sample(unique_counties, size=25)
voters = voters %>% filter(county_desc %in% used_counties)

history = read.csv("../Data/history_stats_20201103.txt", sep="\t") %>%
  filter(county_desc %in% used_counties)

vars_to_remove = c("stats_type", "election_date", "update_date")
for (var in vars_to_remove){
  voters[var] = NULL
  history[var] = NULL
}

# Aggregate the history data set 
agg_by = list(history$county_desc, history$age, history$voted_party_cd, history$race_code, history$ethnic_code, history$sex_code)
history_agg <- aggregate(history$total_voters, agg_by, sum)
colnames(history_agg) = c("county_desc", "age", "voted_party_cd", "race_code", "ethnic_code", "sex_code", "total_voters")

# Aggregate the voters data set
agg_by = list(voters$county_desc, voters$age, voters$party_cd, voters$race_code, voters$ethnic_code, voters$sex_code)
voters_agg <- aggregate(voters$total_voters, agg_by, sum)
colnames(voters_agg) = c("county_desc", "age", "party_cd", "race_code", "ethnic_code", "sex_code", "total_voters")

colnames(history_agg)[3] = "party_cd"
df = left_join(voters_agg, history_agg, suffix=c(".registered", ".actual"), by=c("county_desc", "age", "party_cd", "race_code", "ethnic_code", "sex_code"))

# df$total_voters.actual = replace_na(df$total_voters.actual, 0)
df = df %>% drop_na(total_voters.actual)

deltas = df$total_voters.actual - df$total_voters.registered
df[deltas > 0, "total_voters.actual"] = df[deltas > 0, "total_voters.actual"] - deltas[deltas > 0]

# Fix dtypes
factor_vars = c("county_desc", "party_cd", "race_code", "ethnic_code", "sex_code", "age")
for (fvar in factor_vars){
  df[,fvar] = as.factor(df[,fvar])
}

# Voter Turnout
df$turnout = df$total_voters.actual / df$total_voters.registered
```

Two data sets are available for this analysis. The first one, "Voters", contains the number of registered voters (`total_voters.registered`) with fourteen additional variables and 592,265 rows. The second one, "History", contains the number of actual votes (`total_voters.actual`) with eleven other variables and 928,532 rows. We use only a subset of these data sets for our purposes. We have randomly sampled 25 counties and used them as a filter. The counties used in the analysis are: Cherokee, Dare, Alexander, Pasquotank, Camden, Mitchell, Anson, Vance, Carteret, Perquimans, Edgecombe, Brunswick, New Hanover, Robeson, Mcdowell, Nash, Davidson, Forsyth, Johnston, Northampton, Craven, Haywood, Gates, Alamance, Orange. After filtering, the resulting data sets have 130,709 and 205,303 observations for "Voters" and "History" respectively. Variables `stats_type`, `election_date`, `update_date` are deleted immediately as they are not of interest.  

In order to merge the data from two tables, we have performed aggregations of "History" and "Voters" data sets separately to join the tables correctly. Grouping variables used for the aggregations are: `county_desc`, `age`, `party_cd` (`voted_party_cd`), `race_code`, `ethnic_code`, `sex_code`. The variables `total_voters.actual` and `total_voters.registered` are summed across these groups. Post aggregation, the "History" and "Voters" data sets have 11,374 and 12,935 rows respectively. Post aggregation and after renaming the `voted_party_cd` variable from the "History" data set to `party_cd`, we left join the "History" (right) to the "Voters" (left) data set. The keys for the left join are the same as the grouping variables above and, post join, we now have 12,935 rows. The join induces a large number of N/A values for the `total_voters.actual` column, indicating around 1,000 demographic subgroups registered to vote, but we do not have data on the actual votes. The join also induces ten observations with more actual votes than registered. We decide to lower the amount of actual votes for these observations. In addition, when comparing the number of missing actual votes in the `total_voters.actual` column to the number of excess actual votes, we see that they are highly dissimilar. Thus, we decide to drop all rows with missing values in `total_voters.actual`, which reduces the merged data set to 11,374 observations.

As a part of our EDA, we disaggregate the aggregated actual voting variable to a binary variable with duplicated rows. Conditional probability tables reveal some interesting associations. The voting probability varies for different age groups. Older people tend to vote with higher probability than younger people. The youngest age group "18-25" has a 58.3% probability of voting, whereas the oldest group "Over 66" has a 84.2% probability. Moreover, probability of voting is different across ethnic groups. The Hispanic group has a lower voting probability (58.3%) than Non-Hispanic (76.5%) or Undesignated (73.7%). Voting rates also varies across races: the "Other" group has the lowest probability of voting at 58.9%, whereas the "White" group has 78.6% probability. Additionally, noticeable variation of conditional probabilities can also be observed across party affiliations: Republicans have a 82.1% and Libertarians a 65.7% probability of voting. The most interesting interactions are `party_cd`:`sex_code` and `party_cd`:`age`. The relationship between turnout rate and sex is reversed for the Libertarian party and the Unaffiliated group. It is higher for female in Unaffiliated and higher for male in Libertarian party. Green party has higher turnout rate for younger people in 18-25 years category than any other parties have. We will examine these interactions further during modeling process. Finally, the variable `county_desc` may be a hierarchical one as turnout rate varies across different counties and the number of observation substantially differs. Thus, rather than using this variable as categorical one in our logistic regression, we should try using it as a hierarchical level. 

# Model
```{r echo=FALSE}
load("../model4.Rdata")


```

In order to answer the report questions we used hierarchical logistic regression model. As a first step we started our modelling with regular logistic regression and used stepwise approach for the variable selection. We created our Null model as an intercept only and Full model with `party_cd`, `race_code`, `ethnic_code`, `sex_code`, `age` variables. The resulting stepwise model keeps all the variables. The only insignificant categories in the stepwise model are "Democrats", "Republicans" in `party_cd` variable in comparison to the baseline "Constitution party" which gives us confidence to proceed further.
We experienced model convergence issues while fitting a hierarchical model. Changing the data pre-processing part such as aggregating not only `History` data set, but `Voters` data set too. In addition, switching to a different optimizer eventually solved the problem. 
Our final model contains `party_cd`, `race_code`, `ethnic_code`, `sex_code`, `age` variables and `sex_code`:`party_cd` ,`age`:`party_cd` interactions. The hierarchical level uses `county_desc` variable for creating random intercepts. 

$$\\y_{ij}|x_{ij} \thicksim Bernoulli(turnout_{ij})$$

\begin{equation*}
  \begin{aligned}
\log(\frac{turnout_i}{1-turnout_i}) = (\beta_{0} + \gamma_{0j}) + \beta_1\cdot{\rm party\_cd}_{ij} + \beta_2\cdot{\rm race\_code}_{ij}+\beta_3\cdot{\rm ethnic\_code}_{ij} \\
+ \beta_4\cdot{\rm sex\_code}_{ij} + \beta_4\cdot{\rm age}_{ij} + \beta5\cdot{\rm sex\_code:party\_cd}_{ij} + \beta6\cdot{\rm age:party\_cd}_{ij}
\end{aligned}
\end{equation*}

$$\gamma_{0j} \sim \mathcal{N}(0, \sigma_{0}^2), i=1, ..., n; j=1,...,J $$
All categories in `race_code` variable are significant and highly dispersed. Race code "B" - Black decreases the log odds ratio by 0.1869 which is 0.83 (exp(-0.1869)) multiplicative effect or 17% decrease in odds ratio in comparison to base level "A" - Asian. On the other hand, race code "U" - Undesignated increases log odds ratio by 0.2467 or by 1.28 (exp(0.2467)) multiplicative effect or increasing odds ration by 28% keeping all the other variables fixed. The variable `ethnic_code` has all significant categories too. Being Non-Hispanic is associated with increasing log odds by 0.42 (1.52 in odds ratio) in comparison to Hispanic ethnic group and being part of Undesignated ethnic group is associated with increasing log odds ratio by 0.30 (1.35 in odds ratio). There is no significant difference by `sex_code` variable in comparison with the baseline level. So, we can not conclude that being male or female or undesignated is associated with higher or lower turnout rates. Being part of Liberal party is associated with decreasing log odds ratio by the factor of 0.6728 (0.51 odds ratio) and this category is the only significant one in comparison to Constitutional party.


```{r, echo=FALSE,out.width="105%", out.height="22%",fig.cap="Turnout prediction plots", fig.show='hold', fig.align='center'}

knitr::include_graphics("../Presentation/Images/part2_turnout_predplot_2in1.png")
``` 

From the dotplot we can conclude that only four counties have non-significant random intercept. Counties such as Carteret, Alexander, Orange, Dare, Alamance, Johnston, Nash, Davidson, Haywood, Forsyth are associated with increasing log odds ratios in decreasing order of the increasing effect. Counties such as Robeson, Cherokee, Anson, Pasquotank, Gates, Craven, Camden, Edgecomb, Northhampton are associated with increasing log odds ratios. For example, voters from Cartener county tend to have higher turnout and voters from Robeson lower turnout. Overall, the model confirmed that the odds of voting indeed differ by county. Among all counties, Anson, Cherokee, and Robeson have the lowest turnouts; Carteret, Alexander, and Orange have the highest turnouts. 

We have two significant levels of party by sex interaction. Being a male and a member of Green party is associated with increasing log odds ratio by 0.786 (2.19 odds ratio) in comparison to a female member of Constitutional party. The second significant level is a Libertarian party member with undesignated sex category. This level is associated with increasing log odds ratio 0.74 (2.10 odds ratio).

The coefficients for the party and age groups interaction have more variability. So, regardless of the party age group "26-40" is associated with decreasing log odds in comparison the baseline age group "18-25" and Constitutional party category. The opposite effect holds for the age group "Over 66" which is associated with increasing log odds ratio regardless of the party categories. The more interesting situation in the age group of "41-65" which has one level Green party with decreasing odds ratio -0.09 (0.91 odds ratio), however not significant.


# Conclusion
In this study, we investigated how different groups in North Carolina voted in the 2020 elections. We used hierarchical logistic regression to model how groups cast their votes in the election. Our final model contains `party_cd`, `race_code`, `ethnic_code`, `sex_code`, `age` variables and `sex_code` and `party_cd` interaction, `age` and `party_cd` interaction as fixed effects, and `county_desc` as the hierarchical variable with random intercepts. 

""" Question 1 and 3"""
This model first provided insights into how different demographic groups voted in the 2020 general election. According to the model, ethnic groups and race groups have significantly different turnout rates. Black tends to decrease in 17% turnout rates in comparison to Asians. Non-Hispanic turnout rates also tend to increase by 42% in comparison to Hispanic voters. On the other hand, the model suggested no significant difference in how votes differ by gender (male, female, and undesignated) unless it is combined with party affiliation. For example, a male of the Green party or an undesignated gender of the Libertarian Party both tends to have higher turnout rates than a female of the Constitutional party. [TODO: age by itself, and maybe move gender:party to the paragraph below]

""" Queston 2"""
We used the model to analyze the turnout rates difference between the counties in North Carolina. Due to the parameters limitation of the model, we were only able to examine 25 counties. Among all counties, Anson, Cherokee, and Robeson have the lowest turnouts, and Carteret, Alexander, and Orange have the highest turnouts. This is also an indication that the odds of voting could indeed differ by counties. The difference in turnout rates could be contributed by the demographic breakdown in each county, which is a topic worth examing in future analysis. 

""" Question 4"""
Finally, the model showed the difference in turnout rate by age group for different party affiliations. So, regardless of the party, the age group "26-40" is associated with lower turnout rates than the age group "18-25" affiliated with the Constitutional party category. In contrast, the age group "Over 66" was associated with increasing turnout rates regardless of party affiliation. There also seems to be an insignificant pattern in which the age group of "41-65" has a lower turnout rate when affiliated with the green party. 

""" Limitation and Future Work"""
There are multiple limitations of the dataset and the analysis. The hierarchical model could encounter convergence issues when there are too many parameters in the model. Because there are too many counties in North Carolina, it will be impossible to model, visualize, and interpret if we include all the counties. We randomly selected only 25 counties from North Carolina. And, as a result, our model might not be insightful towards to voting pattern of the entire North Carolina state. Another limitation of the model is that we have to manually modify the voter registration and voter turnout dataset because people voted differently from their party affiliation. This would result in more people voting for a party than the people registered; we cannot use this data directly. In the future, we would like to revisit this dataset to analyze counties excluded from this analysis. And, we are also interested in analyzing voting patterns for the past presidential election years and examining how different demographic groups react to the presidential candidates. 
